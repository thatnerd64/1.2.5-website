<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft 1.2.5 Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Minecraft', Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loading-container {
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .intro {
            text-align: center;
            max-width: 600px;
            padding: 20px;
        }

        .intro p {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .intro button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            margin: 10px;
        }

        .intro button:hover {
            background: #45a049;
        }

        .intro button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .disclaimer {
            font-size: 12px;
            color: #888;
            margin-top: 30px;
            padding: 15px;
            border-top: 1px solid #333;
        }

        .display {
            width: 100%;
            height: 100%;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .mods-info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 14px;
        }

        .mods-info h3 {
            margin-bottom: 10px;
            color: #4CAF50;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <p class="text-center">Loading CheerpJ...</p>
        </div>

        <div id="intro" class="intro hidden">
            <h1>Minecraft 1.2.5 Browser</h1>
            <p>
                This is a proof-of-concept demo of Minecraft 1.2.5 running unmodified in the browser using CheerpJ.
            </p>

            <div class="mods-info">
                <h3>Mod Support</h3>
                <p>Place your mod JAR files in the <code>/mods</code> folder to load them automatically.</p>
                <p>Supported mods: Any Forge-compatible mods for Minecraft 1.2.5</p>
                </div>
                
            <div id="eula-section">
                <p>
                    <input type="checkbox" id="eula-accepted" />
                    <label for="eula-accepted">
                        I accept the <a href="https://www.minecraft.net/eula" target="_blank">Minecraft EULA</a>
                    </label>
                </p>
        </div>

        <div id="play-section" class="hidden">
                <p>Enter a username to play offline:</p>
                <input type="text" id="username" maxlength="16" placeholder="Player" />
                <p class="text-center">Optional multiplayer server:</p>
                <input type="text" id="server" placeholder="server address" />
                <input type="text" id="port" placeholder="port" value="25565" />
                <p>Clicking the button below will load the game from the local JAR file.</p>
                <button id="play-button" onclick="startGame()">Play Minecraft!</button>
                    </div>

            <button id="reset-storage">Reset CheerpJ Storage</button>

            <div class="disclaimer">
                This is not an official Minecraft product. It is not approved by or associated with Mojang or Microsoft.
                You must have a legal copy of Minecraft 1.2.5 to use this application.
            </div>
        </div>

        <div id="progress-container" class="hidden">
            <p>Loading Minecraft JAR...</p>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>

        <div id="display" class="display">
            <canvas id="minecraft-canvas" width="854" height="480"></canvas>
        </div>
    </div>

    <script>
        // Minecraft JAR configuration - store game files in writable CheerpJ /files directory
        const MINECRAFT_DIR = "/files/.minecraft";
        const LOCAL_MINECRAFT_DIR = "./minecraft";
        const LOCAL_JAR_PATH = `${LOCAL_MINECRAFT_DIR}/bin/minecraft-1.2.5.jar`;
        const CHEERPJ_JAR_PATH = `${MINECRAFT_DIR}/bin/minecraft-1.2.5.jar`;
        const LWJGL_JAR_PATH = "/files/lwjgl-2.9.3.jar";
        const LWJGL_UTIL_JAR_PATH = "/files/lwjgl_util-2.9.3.jar";

        // URL parameters for testing/automation
        const urlParams = new URLSearchParams(window.location.search);
        const AUTO_START = urlParams.get('autostart') === '1';
        const DEFAULT_USERNAME = urlParams.get('username') || `Player${Math.floor(Math.random()*1000)}`;
        const DEFAULT_SERVER = urlParams.get('server') || '';
        const DEFAULT_PORT = urlParams.get('port') || '25565';

        // DOM elements
        let loading, intro, display, progressContainer, progressFill, eulaCheckbox, playSection, usernameInput, serverInput, portInput, resetStorageButton;

        let lastLoadedJar = null;

        // Initialize CheerpJ
        // Load a JAR file into CheerpJ filesystem
        async function loadJarToCheerpJ(localPath, cheerpjPath, jarName) {
            lastLoadedJar = jarName;
            try {
                console.log(`Loading ${jarName} from local server...`);

                const response = await fetch(localPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${jarName}: ${response.status}`);
                }

                let bytes;
                try {
                    // Use arrayBuffer if Content-Length header is missing or incorrect
                    const buffer = await response.arrayBuffer();
                    bytes = new Uint8Array(buffer);
                } catch (e) {
                    // Fallback to streaming in chunks if arrayBuffer fails
                    const reader = response.body.getReader();
                    const contentLengthHeader = response.headers.get('Content-Length');
                    const totalSize = contentLengthHeader ? +contentLengthHeader : null;
                    const chunks = [];
                    let loaded = 0;
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        loaded += value.length;
                        if (totalSize) {
                            const progress = (loaded / totalSize) * 100;
                            progressFill.style.width = progress + '%';
                        }
                    }
                    bytes = new Uint8Array(loaded);
                    let offset = 0;
                    for (const chunk of chunks) {
                        bytes.set(chunk, offset);
                        offset += chunk.length;
                    }
                }
                console.log(`${jarName} loaded successfully, total bytes:`, bytes.length);

                console.log(`Writing ${jarName} to CheerpJ filesystem...`);
                console.log('JAR size:', bytes.length, 'bytes');
                console.log('Target path:', cheerpjPath);

                // Ensure target directory exists in CheerpJ filesystem.
                const dirPath = cheerpjPath.substring(0, cheerpjPath.lastIndexOf('/'));
                const dirSegments = dirPath.split('/').filter(Boolean);
                let accumulatedPath = '';
                for (let i = 0; i < dirSegments.length; i++) {
                    accumulatedPath += '/' + dirSegments[i];
                    if (i === 0) continue; // skip creating the mount point (e.g., /files)
                    await new Promise(resolve => {
                        cheerpOSCreateDir(accumulatedPath, {}, 0o777, () => resolve());
                    });
                }

                // Prefer high-level helper if available
                if (typeof cheerpjWriteFile === 'function') {
                    await new Promise((resolve, reject) => {
                        cheerpjWriteFile(cheerpjPath, bytes, err => {
                            if (err) {
                                reject(err);
                            } else {
                                resolve();
                            }
                        });
                    });
                    console.log(`${jarName} written to CheerpJ filesystem successfully`);
                    return;
                }

                // Fallback to manual chunked write
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('CheerpJ filesystem operations timed out after 10 seconds'));
                    }, 10000);

                    var fds = [];
                    cheerpOSOpen(fds, cheerpjPath, "w", fd => {
                        if (fd < 0) {
                            clearTimeout(timeout);
                            reject(new Error('Failed to open file in CheerpJ filesystem, fd: ' + fd));
                            return;
                        }

                        const CHUNK_SIZE = 64 * 1024; // 64KB
                        let offset = 0;

                        function writeChunk(cb = () => {}) {
                            if (offset >= bytes.length) {
                                cheerpOSClose(fds, fd, () => {
                                    clearTimeout(timeout);
                                    console.log(`${jarName} written to CheerpJ filesystem successfully`);
                                    cb();
                                    resolve();
                                });
                                return;
                            }

                            const end = Math.min(offset + CHUNK_SIZE, bytes.length);
                            const chunk = bytes.subarray(offset, end);

                            cheerpOSWrite(fds, fd, chunk, 0, chunk.length, w => {
                                if (w < 0) {
                                    clearTimeout(timeout);
                                    reject(new Error('Failed to write to CheerpJ filesystem, written: ' + w));
                                    return;
                                }

                                offset += w;
                                writeChunk(cb);
                            });
                        }

                        writeChunk();
                    });
                });

            } catch (error) {
                console.error(`Failed to load ${jarName}:`, error);
                throw error;
            }
        }

        // Load all required JARs
        async function loadMods() {
            const modsParam = urlParams.get('mods');
            if (modsParam === 'none') {
                console.log('Mods to load: (none)');
                return;
            }

            let modList = [];
            try {
                const response = await fetch(`${LOCAL_MINECRAFT_DIR}/mods/`);
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'));
                modList = links
                    .map(a => a.getAttribute('href'))
                    .filter(href => href && href.endsWith('.jar'))
                    .map(href => href.split('/').pop());
            } catch (err) {
                console.warn('Could not dynamically load mods from directory listing, falling back to empty list.', err);
                modList = [];
            }

            let modsToLoad = modList;
            if (modsParam) {
                const allowed = new Set(modsParam.split(',').map(m => m.trim()));
                modsToLoad = modList.filter(m => allowed.has(m.replace(/\.jar$/, '')));
            }

            console.log('Mods to load:', modsToLoad.length ? modsToLoad.join(', ') : '(none)');

            try {
                for (const modFile of modsToLoad) {
                    const name = modFile;
                    await loadJarToCheerpJ(`${LOCAL_MINECRAFT_DIR}/mods/${name}`, `${MINECRAFT_DIR}/mods/${name}`, `Mod ${name}`);
                }
            } catch (err) {
                console.warn('Error loading mods:', err);
            }
        }

        async function loadAllJars() {
            console.log('Loading all JAR files...');
            showElement(progressContainer);
            hideElement(intro);

            // Load Minecraft JAR from core minecraft folder
            await loadJarToCheerpJ(LOCAL_JAR_PATH, CHEERPJ_JAR_PATH, "Minecraft");

            // Load LWJGL JARs
            await loadJarToCheerpJ("./lib/lwjgl/lwjgl-2.9.3.jar", LWJGL_JAR_PATH, "LWJGL");
            await loadJarToCheerpJ("./lib/lwjgl/lwjgl_util-2.9.3.jar", LWJGL_UTIL_JAR_PATH, "LWJGL Util");

            // Load mods if any
            await loadMods();

            console.log('All JARs loaded successfully');
        }

        function buildLaunchArgs() {
            const username = (usernameInput.value || DEFAULT_USERNAME).trim();
            const host = (serverInput && serverInput.value.trim()) || '';
            const port = (portInput && portInput.value.trim()) || '25565';
            const args = ["--username", username];
            if (host) {
                args.push("--server", host);
                args.push("--port", port);
            }
            console.log('Using username:', username);
            if (host) {
                console.log('Connecting to server:', host + ':' + port);
            }
            return args;
        }

        // Start the game
        async function startGame() {
            try {
                console.log('Starting Minecraft...');

                // Load all JARs into CheerpJ filesystem
                await loadAllJars();

                // Indicate loading finished for tests
                window.gameLoaded = true;

                // Give CheerpJ a moment to process the JAR files
                console.log('Waiting for CheerpJ to process JAR files...');
                await new Promise(resolve => setTimeout(resolve, 1000));

                hideElement(progressContainer);
                showElement(display);

                console.log('Running Minecraft main class...');

                // Set up LWJGL canvas for native library support
                window.lwjglCanvasElement = document.getElementById('minecraft-canvas');
                if (typeof cheerpjCreateDisplay === "function") cheerpjCreateDisplay(854, 480);
                console.log('LWJGL canvas element set:', window.lwjglCanvasElement);
                const launchArgs = buildLaunchArgs();
                try {
                    await cheerpjRunMain("net.minecraft.client.Minecraft", launchArgs);
                } catch (e) {
                    console.error("Failed to start game:", e && e.stack || e);
                    if (lastLoadedJar) {
                        console.error('Last JAR loaded:', lastLoadedJar);
                    }
                    throw e;
                }

            } catch (error) {
                console.error('Failed to start game:', error);
                showError('Failed to start game: ' + error.message);
                hideElement(progressContainer);
                hideElement(display);
                showElement(intro);
            }
        }

        // Utility functions
        function showElement(element) {
            element.classList.remove('hidden');
        }

        function hideElement(element) {
            element.classList.add('hidden');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = '#333';
            toast.style.color = '#fff';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '5px';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function resetCheerpJStorage() {
            try {
                if (window.indexedDB && indexedDB.deleteDatabase) {
                    indexedDB.deleteDatabase('cheerpjfs');
                    indexedDB.deleteDatabase('CJFS');
                }
            } catch (e) {
                console.warn('Failed to clear CheerpJ storage:', e);
            }
            showToast('Storage cleared. Reloading…');
            setTimeout(() => location.reload(), 500);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const intro = document.getElementById('intro');
            intro.insertBefore(errorDiv, intro.firstChild);
        }

        // EULA checkbox handler
        function handleEulaChange() {
            if (eulaCheckbox.checked) {
                showElement(playSection);
            } else {
                hideElement(playSection);
            }
        }

    </script>

    <!-- Load CheerpJ -->
    <script src="https://cjrtnc.leaningtech.com/4.2/loader.js?v=20250804"></script>
    <script>
      (async () => {
        try {
          await cheerpjInit({
            runtime: "full",
            enableDebug: true,
            javaProperties: ["java.library.path=/cheerpj-natives/natives"]
          });

          window.addEventListener('error', (e) => {
            console.error('Unhandled error:', e.error || e.message, e);
          });
          window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
          });

          // Stub missing native method for CheerpJ runtime
          window.Java_sun_misc_Unsafe_throwException = function (unsafePtr, throwable) {
            throw throwable;
          };

          // Cache frequently used DOM elements once the runtime is ready
          loading = document.getElementById('loading');
          intro = document.getElementById('intro');
          display = document.getElementById('display');
          progressContainer = document.getElementById('progress-container');
          progressFill = document.getElementById('progress-fill');
          eulaCheckbox = document.getElementById('eula-accepted');
          playSection = document.getElementById('play-section');
          usernameInput = document.getElementById('username');
          serverInput = document.getElementById('server');
          portInput = document.getElementById('port');
          resetStorageButton = document.getElementById('reset-storage');

          eulaCheckbox.addEventListener('change', handleEulaChange);
          resetStorageButton.addEventListener('click', resetCheerpJStorage);

          hideElement(loading);
          showElement(intro);

          if (AUTO_START) {
            eulaCheckbox.checked = true;
            handleEulaChange();
            startGame();
          }
        } catch (err) {
          console.error('Failed to initialize CheerpJ:', err);
          showError('Failed to initialize CheerpJ: ' + err.message);
        }
      })();
    </script>
</body>
</html> 
